<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
<link rel="icon" type="image/png" href="imagenes/LogoOrangeHearth.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro - Tutor de Mascota</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <link rel="stylesheet" href="css/main.css"> 
  
  <style>
    /* Estilos espec√≠ficos para el registro */
    :root {
      --naranja: #f28c28;
      --naranja-oscuro: #d86f00;
      --rosa-suave: #ffb766;
      --gris-suave: #f7f4f0;
      --rojo-error: #dc3545;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #fff8f0 0%, #ffecd1 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      min-height: 100vh;
    }

    .registro-box {
      background: white;
      border: 2px solid var(--naranja);
      border-radius: 15px;
      padding: 2.5rem 3rem;
      width: 100%;
      max-width: 950px; /* Ajustado para la nueva columna */
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      display: flex;
      gap: 40px;
    }
    .registro-image {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
        background-color: var(--gris-suave); 
        border-radius: 10px;
    }
    .registro-form {
        flex: 2;
        min-width: 550px;
    }
    .registro-image img {
        max-width: 80%;
        height: auto;
        margin-bottom: 20px;
    }
    .registro-box input, .registro-box select {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        margin-bottom: 5px; 
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        color: #444;
    }
    
    /* Estilos de Validaci√≥n */
    .error-message {
        color: var(--rojo-error);
        font-size: 0.8rem;
        margin-top: 2px;
        min-height: 15px;
        display: block;
    }
    .input-error {
        border-color: var(--rojo-error) !important;
    }
    
    .password-requirements {
        background-color: #fff8e1;
        border: 1px solid #ffcc80;
        padding: 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        margin-top: 10px;
    }
    .password-requirements ul {
        list-style: none;
        padding: 0;
        margin: 5px 0 0 0;
    }
    .req-item {
        color: var(--rojo-error);
    }
    .req-item.valid {
        color: #28a745;
    }
    
    .btn-registro {
        background-color: var(--naranja);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 5px;
        width: 100%;
        margin-top: 20px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s;
    }
    .btn-registro:hover {
        background-color: var(--naranja-oscuro);
    }

    /* Media Queries para Responsividad */
    @media (max-width: 992px) {
      .registro-box {
        flex-direction: column; /* Apilar imagen y formulario */
        max-width: 600px; /* Ajustar ancho m√°ximo para pantallas medianas */
        padding: 2rem;
      }
      .registro-image {
        padding: 15px;
        margin-bottom: 20px;
      }
      .registro-form {
        min-width: auto; /* Eliminar el min-width fijo */
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .registro-box {
        padding: 1.5rem;
      }
      .direccion-grid {
        /* Simplificar el grid de direcci√≥n para m√≥viles */
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Columnas flexibles */
        gap: 8px;
      }
      .direccion-grid span { display: none; } /* Ocultar los separadores # y - */
    }
  </style>
</head>
<body>
    <div class="registro-box">
        
        <div class="registro-image">
            <img src="imagenes/FondoRegistroTutor.jpeg" alt="Tutor y Mascota">
            <img src="imagenes/LogoOrangeHearth.png" alt="Logo" style="max-width: 150px;">
            <h3>¬°Tu Mascota te lo agradecer√°!</h3>
            <p>Completa el formulario para empezar a gestionar la salud de tu compa√±ero.</p>
        </div>

        <div class="registro-form">
            <h2>Registro de Nuevo Tutor</h2>

            <form id="form-registro-usuario">
                <h4 style="color: var(--naranja-oscuro); margin-top: 20px;">1. Datos Personales (Tutor)</h4>
                
                <div class="form-group">
                    <label for="nombreTutor">Nombre completo *</label>
                    <input type="text" id="nombreTutor" name="nombre" placeholder="Nombre completo" required data-validation="name">
                    <span class="error-message" id="error-nombreTutor"></span>
                </div>
                
                <div class="form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="tipoDocumento">Tipo Doc. *</label>
                        <select id="tipoDocumento" name="tipoDocumento" required>
                            <option value="">-- Seleccionar --</option>
                            <option value="CC">C√©dula de Ciudadan√≠a (CC)</option>
                            <option value="TI">Tarjeta de Identidad (TI)</option>
                            <option value="CE">C√©dula de Extranjer√≠a (CE)</option>
                            <option value="PA">Pasaporte (PA)</option>
                            <option value="OTRO">Otro</option>
                        </select>
                        <span class="error-message" id="error-tipoDocumento"></span>
                    </div>
                    <div style="flex: 2;">
                        <label for="numeroDocumento">N√∫mero de Documento *</label>
                        <input type="number" id="numeroDocumento" name="numeroDocumento" placeholder="Sin puntos ni comas" required minlength="2" maxlength="10" data-validation="doc-number">
                        <span class="error-message" id="error-numeroDocumento"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="telefonoTutor">Tel√©fono (Solo 10 d√≠gitos) *</label>
                    <input type="tel" id="telefonoTutor" name="telefono" placeholder="Ej: 3001234567" required pattern="^\d{10}$" title="Debe contener exactamente 10 d√≠gitos num√©ricos." data-validation="phone">
                    <span class="error-message" id="error-telefonoTutor"></span>
                </div>
                
                <div class="form-group">
                    <label for="direccionCompleta">Direcci√≥n de residencia *</label>
                    <input type="text" id="direccionCompleta" name="direccionCompleta" placeholder="Ej: Calle 68 # 63-35" required>
                    <span class="error-message" id="error-direccion"></span>
                </div>

                <div class="form-group">
                    <label for="dirAdicional">Detalle adicional (opcional)</label>
                    <input type="text" id="dirAdicional" name="dirAdicional" placeholder="Apartamento, torre, referencia, etc.">
                </div>


                <div class="form-group">
                    <label for="correoTutor">Correo Electr√≥nico *</label>
                    <input type="email" id="correoTutor" name="correo" placeholder="correo@gmail.com" required data-validation="email">
                    <span class="error-message" id="error-correoTutor"></span>
                </div>

                <div class="form-group">
                    <label for="passwordTutor">Contrase√±a *</label>
                    <input type="password" id="passwordTutor" name="password" required data-validation="password">
                    <span class="error-message" id="error-passwordTutor"></span>
                    
                    <div class="password-requirements" id="pass-reqs">
                        Requisitos:
                        <ul>
                            <li id="req-length" class="req-item">M√≠nimo 8 caracteres</li>
                            <li id="req-upper" class="req-item">Al menos una may√∫scula (A-Z)</li>
                            <li id="req-number" class="req-item">Al menos un n√∫mero (0-9)</li>
                            <li id="req-symbol" class="req-item">Al menos un s√≠mbolo (!@#$%^&*)</li>
                        </ul>
                    </div>
                </div>

                <div class="form-group">
                    <label for="securityAnswer">Pregunta de seguridad</label>
                    <p style="margin: 0 0 5px 0; font-size: 0.9rem; color: #444;">
                        Pregunta de seguridad: <strong>¬øCu√°l es el nombre de tu primera mascota?</strong>
                    </p>
                    <input type="text" id="securityAnswer" name="securityAnswer" placeholder="Escribe aqu√≠ tu respuesta" required>
                    <span class="error-message" id="error-securityAnswer"></span>
                    <small style="display:block; margin-top: 4px; color: #555;">
                        Este dato es obligatorio. Usaremos esta respuesta para verificar tu identidad si olvidas tu contrase√±a.
                    </small>
                </div>
                
                <div th:insert="fragments/mascota-form :: mascotaForm"></div>

                <button type="submit" class="btn-registro">Crear Cuenta y Registrar Mascota</button>
                <p style="margin-top: 15px; text-align: center;">¬øYa tienes cuenta? <a href="login-rol.html" style="color: var(--naranja);">Ingresa aqu√≠</a></p>
            </form>
        </div>
    </div>

    <script>
        
        // ===========================================
        // üêæ Datos de Razas por Especie
        // ===========================================
        const RACES_BY_SPECIES = {
            'Perro': ['Labrador Retriever', 'Pastor Alem√°n', 'Golden Retriever', 'Bulldog', 'Poodle', 'Chihuahua', 'Mestizo' , 'Criollo', 'Otro (especificar en Adicional)'],
            'Gato': ['Siam√©s', 'Persa', 'Maine Coon', 'Bengala', 'Ragdoll', 'Sphynx', 'Mestizo' , 'Criollo' , 'Otro (especificar en Adicional)'],
            'Ave': ['Periquito', 'Canario', 'Cacat√∫a', 'Loro', 'Agapornis', 'Torcaza', 'Otro (especificar en Adicional)'],
            'Roedor': ['H√°mster', 'Conejillo de Indias', 'Conejo', 'Jerbo', 'Rata Dom√©stica', 'Otro (especificar en Adicional)'],
            'Otro': ['No Aplica / Otra (especificar en Adicional)']
        };

        // ===========================================
        // L√ìGICA DE VALIDACI√ìN Y EVENTOS
        // ===========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('form-registro-usuario');

            // --- Funciones de Utilidad ---
            
            /** Muestra u oculta un mensaje de error y marca el input */
            function setFieldError(input, message) {
                // Obtener el ID del elemento a mostrar el error
                const errorId = input.id ? `error-${input.id}` : (input.name === 'tipoDocumento' ? 'error-tipoDocumento' : '');
                const errorElement = document.getElementById(errorId);
                
                if (message) {
                    input.classList.add('input-error');
                    if(errorElement) errorElement.textContent = message;
                    return false;
                } else {
                    input.classList.remove('input-error');
                    if(errorElement) errorElement.textContent = '';
                    return true;
                }
            }
            
            // --- Validaciones Espec√≠ficas (Se mantienen) ---

            /** Valida Nombre (solo letras y espacios) y Nombre de Mascota */
            function validateNameField(input) {
                const value = input.value.trim();
                const regex = /^[A-Za-z√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö\s]+$/;
                if (!value) return setFieldError(input, 'Este campo es obligatorio.');
                if (!regex.test(value)) return setFieldError(input, 'Solo se permiten letras y espacios.');
                return setFieldError(input, '');
            }

            /** Valida N√∫mero de Documento (2 a 10 d√≠gitos num√©ricos) */
            function validateDocNumber(input) {
                const value = input.value.trim();
                const regex = /^\d{2,10}$/; // 2 a 10 d√≠gitos
                if (!value) return setFieldError(input, 'Este campo es obligatorio.');
                if (!regex.test(value)) return setFieldError(input, 'Debe tener entre 2 y 10 d√≠gitos num√©ricos.');
                return setFieldError(input, '');
            }

            /** Valida Tel√©fono (Exactamente 10 d√≠gitos) */
            function validatePhone(input) {
                const value = input.value.trim();
                const regex = /^\d{10}$/; // Exactamente 10 d√≠gitos
                if (!value) return setFieldError(input, 'Este campo es obligatorio.');
                if (!regex.test(value)) return setFieldError(input, 'Debe ser exactamente 10 d√≠gitos num√©ricos.');
                return setFieldError(input, '');
            }

            /** Valida Correo Electr√≥nico (contiene @) */
            function validateEmail(input) {
                const value = input.value.trim();
                const regex = /^\S+@\S+\.\S+$/; // Patr√≥n b√°sico para email
                if (!value) return setFieldError(input, 'Este campo es obligatorio.');
                if (!regex.test(value)) return setFieldError(input, 'Debe ser un correo electr√≥nico v√°lido (ej. correo@dominio.com).');
                return setFieldError(input, '');
            }

            /** Valida Contrase√±a (Longitud, May√∫sculas, N√∫meros, S√≠mbolos) */
            function validatePassword(input) {
                const value = input.value;
                let isValid = true;

                const reqLength = value.length >= 8;
                const reqUpper = /[A-Z]/.test(value);
                const reqNumber = /[0-9]/.test(value);
                const reqSymbol = /[!@#$%^&*]/.test(value);

                document.getElementById('req-length').classList.toggle('valid', reqLength);
                document.getElementById('req-upper').classList.toggle('valid', reqUpper);
                document.getElementById('req-number').classList.toggle('valid', reqNumber);
                document.getElementById('req-symbol').classList.toggle('valid', reqSymbol);

                if (!(reqLength && reqUpper && reqNumber && reqSymbol)) {
                    isValid = false;
                    setFieldError(input, 'La contrase√±a no cumple con todos los requisitos.');
                } else {
                    setFieldError(input, '');
                }

                return isValid;
            }

            /** Valida la respuesta de seguridad (obligatoria) */
            function validateSecurityAnswer(input) {
                const value = input.value.trim();
                if (!value) {
                    return setFieldError(input, 'La respuesta de seguridad es obligatoria.');
                }
                return setFieldError(input, '');
            }

	            // Ya no se requiere l√≥gica especial de armado de direcci√≥n

            // --- L√≥gica del Campo de Raza (Se mantiene) ---
            window.updateBreedOptions = function() {
                const especieSelect = document.getElementById('especieMascota');
                const razaSelect = document.getElementById('razaMascota');
                const selectedEspecie = especieSelect.value;

                // 1. Limpiar opciones existentes
                razaSelect.innerHTML = '<option value="">-- Seleccionar --</option>';

                // 2. Poblar opciones basadas en la especie
                if (selectedEspecie && RACES_BY_SPECIES[selectedEspecie]) {
                    const breeds = RACES_BY_SPECIES[selectedEspecie];
                    breeds.forEach(breed => {
                        const option = document.createElement('option');
                        option.value = breed;
                        option.textContent = breed;
                        razaSelect.appendChild(option);
                    });
                }
                
                // 3. Limpiar cualquier error de validaci√≥n previo en el campo de raza
                setFieldError(razaSelect, '');
            }
            
	            // Llama a las funciones al cargar para establecer las opciones de raza
	            updateBreedOptions(); 
            
            // --- Asignaci√≥n de Event Listeners (Se mantiene) ---
            
            // Mapeo de validadores para los inputs
	            const validators = {
	                'nombreTutor': validateNameField,
	                'numeroDocumento': validateDocNumber,
	                'telefonoTutor': validatePhone,
	                'direccionCompleta': (input) => setFieldError(input, input.value.trim() ? '' : 'La direcci√≥n es obligatoria.'),
	                'correoTutor': validateEmail,
	                'passwordTutor': validatePassword,
	                'securityAnswer': validateSecurityAnswer,
                'nombreMascota': validateNameField,
                'edadMascota': (input) => setFieldError(input, input.value < 1 ? 'La edad debe ser mayor a cero.' : '')
            };

            // Aplica validaci√≥n al perder el foco (blur)
            Object.keys(validators).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('blur', () => validators[id](input));
                    // Para la contrase√±a, tambi√©n valida en tiempo real
                    if (id === 'passwordTutor') {
                        input.addEventListener('input', () => validatePassword(input));
                    }
                }
            });

	            // Ya no se requiere l√≥gica especial de blur para direcci√≥n
            // --- Manejo del Formulario de Env√≠o (Modificado para redirecci√≥n) ---

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                let isFormValid = true;
                let firstInvalidField = null;

	                // 1. Validar campos obligatorios con validaci√≥n espec√≠fica
                Object.keys(validators).forEach(id => {
                    const input = document.getElementById(id);
                    if (input && !validators[id](input)) {
                        isFormValid = false;
                        if (!firstInvalidField) firstInvalidField = input;
                    }
                });

                // 2. Validar campos select obligatorios (Tipo Doc, Especie, Raza)
                const requiredSelects = form.querySelectorAll('select[required]');
                requiredSelects.forEach(select => {
                    if (!select.value) {
                        setFieldError(select, 'Este campo es obligatorio.');
                        isFormValid = false;
                        if (!firstInvalidField) firstInvalidField = select;
                    } else {
                        setFieldError(select, '');
                    }
                });
                
	                // 3. Validar Direcci√≥n (Es obligatorio)
	                const direccionCompletaInput = document.getElementById('direccionCompleta');
	                const finalDireccion = direccionCompletaInput.value.trim();
	                if (!finalDireccion) {
	                    isFormValid = false;
	                    setFieldError(direccionCompletaInput, 'La direcci√≥n es obligatoria.');
	                    if (!firstInvalidField) firstInvalidField = direccionCompletaInput;
	                } else {
	                    setFieldError(direccionCompletaInput, '');
	                }

                
		                // Si la validaci√≥n pasa, simula el registro y REDIRECCIONA
		                if (isFormValid && finalDireccion) {
	                    const payload = {
	                        nombreCompleto: document.getElementById('nombreTutor').value,
	                        tipoDocumento: document.getElementById('tipoDocumento').value,
	                        numeroDocumento: document.getElementById('numeroDocumento').value,
	                        telefono: document.getElementById('telefonoTutor').value,
	                        correo: document.getElementById('correoTutor').value,
	                        password: document.getElementById('passwordTutor').value,
	                        securityAnswer: document.getElementById('securityAnswer').value,
		                        direccion: {
	                            adicional: document.getElementById('dirAdicional').value,
	                            completo: finalDireccion
	                        },
                        mascota: {
                            nombre: document.getElementById('nombreMascota').value,
                            especie: document.getElementById('especieMascota').value,
                            raza: document.getElementById('razaMascota').value,
                            edadValor: parseInt(document.getElementById('edadMascota').value, 10),
                            edadUnidad: document.getElementById('unidadEdad').value
                        }
                    };

                    try {
                        const response = await fetch('/api/tutores', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json().catch(() => null);

                        if (!response.ok) {
                            const errorMessage = data?.message || 'No se pudo completar el registro.';
                            alert(`‚ùå ${errorMessage}`);
                            return;
                        }

	                        alert('‚úÖ ¬°Registro exitoso! Tu cuenta ha sido creada y tu mascota registrada.');
	                        form.reset();
                        window.location.href = "login-rol.html";
                    } catch (error) {
                        console.error('Error al registrar tutor:', error);
                        alert('‚ùå No se pudo contactar al servidor. Intenta nuevamente en unos minutos.');
                    }
                } else {
                    // Enfocar el primer campo inv√°lido
	                    if (firstInvalidField) {
	                        firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
	                        firstInvalidField.focus();
	                    }
                    alert('Por favor, corrija los errores en el formulario antes de continuar.');
                }
            });
        });
    </script>
    <script src="js/main.js"></script>
</body>
</html>
